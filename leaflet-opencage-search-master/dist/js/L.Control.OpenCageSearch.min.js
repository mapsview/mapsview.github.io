/* 
 * OpenCage Data Search Control v1.2.1 - 2019-07-14
 * Copyright (c) 2019, OpenCage Data 
 * info@opencagedata.com 
 * https://opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: https://opencagedata.com 
 * Source: git@github.com:opencagedata/leaflet-opencage-search.git 
 */

!function(e){var t;if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("undefined"!=typeof module)t=require("leaflet"),module.exports=e(t);else{if(void 0===window.L)throw"Leaflet must be loaded first";e(window.L)}}(function(l){"use strict";return l.Control.OpenCageSearch=l.Control.extend({options:{showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",limit:5},_callbackId:0,initialize:function(e){l.Util.setOptions(this,e),this.options.geocoder||(this.options.geocoder=new l.Control.OpenCageSearch.Geocoder(this.options))},onAdd:function(e){var t,o="leaflet-control-ocd-search",s=l.DomUtil.create("div",o),n=l.DomUtil.create("div","leaflet-control-ocd-search-icon",s),i=this._form=l.DomUtil.create("form",o+"-form",s);return this._map=e,this._container=s,(t=this._input=l.DomUtil.create("input")).type="text",t.placeholder=this.options.placeholder,l.DomEvent.addListener(t,"keydown",this._keydown,this),this._errorElement=document.createElement("div"),this._errorElement.className=o+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=l.DomUtil.create("ul",o+"-alternatives leaflet-control-ocd-search-alternatives-minimized"),i.appendChild(t),i.appendChild(this._errorElement),s.appendChild(this._alts),l.DomEvent.addListener(i,"submit",this._geocode,this),this.options.collapsed?"click"===this.options.expand?l.DomEvent.addListener(n,"click",function(e){0===e.button&&2!==e.detail&&this._toggle()},this):(l.DomEvent.addListener(n,"mouseover",this._expand,this),l.DomEvent.addListener(n,"mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):this._expand(),l.DomEvent.disableClickPropagation(s),s},_geocodeResult:function(e){if(l.DomUtil.removeClass(this._container,"leaflet-control-ocd-search-spinner"),1===e.length)this._geocodeResultSelected(e[0]);else if(0<e.length){this._alts.innerHTML="",this._results=e,l.DomUtil.removeClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized");for(var t=0;t<e.length;t++)this._alts.appendChild(this._createAlt(e[t],t))}else l.DomUtil.addClass(this._errorElement,"leaflet-control-ocd-search-error")},markGeocode:function(e){return e.bounds?this._map.fitBounds(e.bounds):this._map.panTo(e.center),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new l.Marker(e.center).bindPopup(e.name).addTo(this._map).openPopup(),this},_geocode:function(e){return l.DomEvent.preventDefault(e),l.DomUtil.addClass(this._container,"leaflet-control-ocd-search-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1},_geocodeResultSelected:function(e){this.options.collapsed?this._collapse():this._clearResults(),this.markGeocode(e)},_toggle:function(){0<=this._container.className.indexOf("leaflet-control-ocd-search-expanded")?this._collapse():this._expand()},_expand:function(){l.DomUtil.addClass(this._container,"leaflet-control-ocd-search-expanded"),this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-ocd-search-expanded",""),l.DomUtil.addClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized"),l.DomUtil.removeClass(this._errorElement,"leaflet-control-ocd-search-error")},_clearResults:function(){l.DomUtil.addClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized"),this._selection=null,l.DomUtil.removeClass(this._errorElement,"leaflet-control-ocd-search-error")},_createAlt:function(e,t){var o=document.createElement("li");return o.innerHTML='<a href="#" data-result-index="'+t+'">'+(this.options.showResultIcons&&e.icon?'<img src="'+e.icon+'"/>':"")+e.name+"</a>",l.DomEvent.addListener(o,"click",function(){this._geocodeResultSelected(e)},this),o},_keydown:function(e){function t(e){o._selection&&(l.DomUtil.removeClass(o._selection.firstChild,"leaflet-control-ocd-search-selected"),o._selection=o._selection[0<e?"nextSibling":"previousSibling"]),o._selection||(o._selection=o._alts[0<e?"firstChild":"lastChild"]),o._selection&&l.DomUtil.addClass(o._selection.firstChild,"leaflet-control-ocd-search-selected")}var o=this;switch(e.keyCode){case 38:t(-1),l.DomEvent.preventDefault(e);break;case 40:t(1),l.DomEvent.preventDefault(e);break;case 13:if(this._selection){var s=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[s]),this._clearResults(),l.DomEvent.preventDefault(e)}}return!0}}),l.Control.openCageSearch=function(e,t){return new l.Control.OpenCageSearch(e,t)},l.Control.OpenCageSearch.callbackId=0,l.Control.OpenCageSearch.jsonp=function(e,t,o,s,n){var i="_ocd_geocoder_"+l.Control.OpenCageSearch.callbackId++;t[n||"callback"]=i,window[i]=l.Util.bind(o,s);var r=document.createElement("script");r.type="text/javascript",r.src=e+l.Util.getParamString(t),r.id=i,r.addEventListener("error",function(){o({results:[]})}),r.addEventListener("abort",function(){o({results:[]})}),document.getElementsByTagName("head")[0].appendChild(r)},l.Control.OpenCageSearch.Geocoder=l.Class.extend({options:{serviceUrl:"https://api.opencagedata.com/geocode/v1/",geocodingQueryParams:{},reverseQueryParams:{},key:"",limit:5},initialize:function(e){l.Util.setOptions(this,e)},geocode:function(e,s,n){var t={};if(n&&n._map&&n._map.getCenter()){var o=n._map.getCenter();t.proximity=o.lat+","+o.lng}l.Control.OpenCageSearch.jsonp(this.options.serviceUrl+"json/",l.extend({q:e,limit:this.options.limit,key:this.options.key},t,this.options.geocodingQueryParams),function(e){for(var t=[],o=e.results.length-1;0<=o;o--)t[o]={name:e.results[o].formatted,center:l.latLng(e.results[o].geometry.lat,e.results[o].geometry.lng)},e.results[o].bounds&&(t[o].bounds=l.latLngBounds([e.results[o].bounds.southwest.lat,e.results[o].bounds.southwest.lng],[e.results[o].bounds.northeast.lat,e.results[o].bounds.northeast.lng]));s.call(n,t)},this,"jsonp")},reverse:function(e,t,o,s){this.geocode(e,o,s)}}),l.Control.OpenCageSearch.geocoder=function(e){return new l.Control.OpenCageSearch.Geocoder(e)},l.Control.OpenCageSearch});